<?php

namespace AiosInitialSetup\App\Controllers;

use AiosInitialSetup\Config\Config;

class DashboardController
{
  use Config;

  /**
   * DashboardController constructor.
   */
  public function __construct()
  {
	  if (! is_admin()) return;

    $loginScreen = get_option('aios_custom_login_screen');
    $loginScreen = ! empty($loginScreen) ? $loginScreen : 'default';

    if ($loginScreen !== 'thedesignpeople') {
      add_action('admin_init', [$this, 'get_agentimage_details'], 12);
      add_action('wp_dashboard_setup', [$this, 'amnwidget'], 999);
    }
  }

  /**
   * Global declare $jsondata_ai_detail but this need to be transfer once init.dashboard.class.php is used
   *
   * @since 3.8.8
   */
  public function get_agentimage_details(){
    $jsondata_ai_detail = get_transient('jsondata_ai_detail');
    $jsondata_ai_detail = $jsondata_ai_detail !== false ? $jsondata_ai_detail : $this->dashboardData();
    set_transient( 'jsondata_ai_detail', $jsondata_ai_detail, 72 * HOUR_IN_SECONDS );
  }

  /**
   * Add dashboard meta box
   *
   * @since 3.8.8
   */
  public function amnwidget() {
    remove_meta_box('dashboard_right_now', 'dashboard', 'normal');
    remove_meta_box('dashboard_activity', 'dashboard', 'normal');
    remove_meta_box('dashboard_recent_comments', 'dashboard', 'normal');
    remove_meta_box('dashboard_incoming_links', 'dashboard', 'normal');
    remove_meta_box('dashboard_plugins', 'dashboard', 'normal');

    remove_meta_box('dashboard_quick_press', 'dashboard', 'side');
    remove_meta_box('dashboard_recent_drafts', 'dashboard', 'side');
    remove_meta_box('dashboard_primary', 'dashboard', 'side');
    remove_meta_box('dashboard_secondary', 'dashboard', 'side');
    remove_meta_box('agent_image_news-dashboard-widget', 'dashboard', 'side');

    add_meta_box(
      'amnwidget',
      'Agent Image News',
      [$this, 'amn_widget_display'],
      'dashboard',
      'side',
      'high'
    );
  }

  /**
   * Callback function for Agent Image News
   *
   * @since 3.8.8
   */
  public function amn_widget_display() {
    $jsondata_ai_detail = get_transient('jsondata_ai_detail', []);

    // Get RSS Feed(s)
    require_once(ABSPATH . WPINC . '/feed.php');

    $maximum_number_of_items_to_show = 3;
    $subtitle = $jsondata_ai_detail['sub-title'] ?? 'Real Estate Website Design';
    $sales = $jsondata_ai_detail['phone']['sales'] ?? '1.800.979.5799';
    $support = $jsondata_ai_detail['phone']['support'] ?? '1.877.317.4111';

    $feed_content = '<div class="amw-logo">
        <a href="//www.agentimage.com/" target="_blank" class="amw-logo-link">
            <svg width="542" height="96" viewbox="0 0 542 96" fill="none" xmlns="http://www.w3.org/2000/svg" style="max-width: 300px; width: 100%; height: auto;">
<path d="M69.4473 95.4393H105.096V91.7424H100.713C98.083 91.7424 96.0376 90.0885 94.2844 86.3915L80.8431 57.2051L74.4147 71.4091L80.7457 85.6132C81.6223 87.7536 81.6223 89.4075 80.8431 90.4776C80.2587 91.2559 79.2847 91.7424 78.1159 91.7424H69.4473V95.4393Z" fill="#009BBB"/>
<path d="M0.194801 95.4397H35.6486V91.7427H26.2981C24.7397 91.7427 23.9605 91.0617 23.6683 90.5753C22.9865 89.5051 23.1813 87.9485 23.6683 87.0729L52.4014 23.7383V23.1546L52.6936 23.7383L67.2063 56.1353V56.2326L49.6742 95.3424H57.4663L88.3422 26.0732C88.537 25.6841 89.4136 23.641 90.6798 21.6953C92.6278 18.7766 94.4784 17.22 96.3291 17.22H96.4265H100.322V14.3986H84.5436L84.641 14.2041C85.5176 12.2583 86.8812 11.9664 88.4396 11.7719C93.0174 11.2854 95.7447 10.5071 97.5953 9.0478C99.3485 7.78305 99.9329 5.74 99.2511 3.01593C98.9589 1.75119 98.4719 0.681017 98.0823 0C98.1797 1.26475 97.8875 2.52949 97.1083 3.59966C96.0369 5.15627 93.894 6.42102 91.946 6.61559L91.2642 6.71288L91.8486 6.42102C94.0888 5.15627 94.2836 3.21051 94.1862 2.33492C93.407 3.69695 92.2382 4.0861 89.1214 4.66983C82.5956 5.83729 81.232 12.7447 81.232 12.842C80.9398 13.7176 80.9398 14.3014 80.9398 14.3014V14.3986H72.5633V17.22H78.1152C78.6996 17.22 80.8424 17.4146 81.8164 18.9712C82.5956 20.1386 82.4982 21.7925 81.6216 23.8356L73.6348 42.1258L73.5373 41.8339L57.7585 7.3939H49.5768L12.1751 86.3919C10.227 90.0888 8.08424 91.7427 5.16222 91.9373H0V95.4397H0.194801Z" fill="#009BBB"/>
<path d="M153.51 70.1963H160.794L141.399 26.7227H134.641L115.246 70.1963H122.267L126.918 59.5734H148.946L153.51 70.1963ZM146.489 53.6817H129.376L129.463 53.5032L137.888 34.2212L137.976 34.489L146.489 53.6817Z" fill="#009BBB"/>
<path d="M184.183 26.2324C171.457 26.2324 161.52 36.0466 161.52 48.5373V48.6266C161.52 61.6526 170.846 70.8423 184.27 70.8423C192.725 70.8423 198.827 67.2735 202.488 64.24V46.4853H187.408L184.706 52.1953H195.863V61.2065L195.689 61.385C192.725 63.5263 188.628 64.7753 184.532 64.7753C175.205 64.7753 168.754 58.0838 168.754 48.5373V48.4481C168.754 39.6154 175.553 32.3886 183.834 32.3886C189.587 32.3886 192.987 34.173 196.386 36.9388L200.745 31.8533C195.863 27.8384 191.069 26.2324 184.183 26.2324Z" fill="#009BBB"/>
<path d="M210.629 70.1968H241.709L240.059 64.3194H217.487V51.4958H236.673V45.6183H217.487V33.1509H239.712L241.361 27.2734H210.629V70.1968Z" fill="#009BBB"/>
<path d="M281.959 70.1065H287.792V26.7227H281.088V58.4297L280.827 58.1602L256.276 26.8125H249.746V70.1963H256.537V37.6809L256.798 37.9504L281.959 70.1065Z" fill="#009BBB"/>
<path d="M308.457 70.1963H315.443V32.9332H327.843L329.589 26.7227H294.223V32.9332H308.457V70.1963Z" fill="#009BBB"/>
<path d="M346.199 70.1963H353.165V26.7227H346.199V70.1963Z" fill="#009BBB"/>
<path d="M400.911 70.1963H407.824V26.8125H400.123L386.122 48.19L386.035 48.0104L372.121 26.7227H364.42V70.1065H371.158V37.2318L371.421 37.5911L385.947 58.9686L400.824 37.0521L400.911 70.1963Z" fill="#009BBB"/>
<path d="M451.98 70.1963H459.265L439.869 26.7227H433.112L413.717 70.1963H420.738L425.389 59.5734H447.417L451.98 70.1963ZM444.96 53.6817H427.846L427.934 53.5032L436.359 34.2212L436.447 34.489L444.96 53.6817Z" fill="#009BBB"/>
<path d="M483.075 26.2324C470.349 26.2324 460.412 36.0466 460.412 48.5373V48.6266C460.412 61.6526 469.739 70.8423 483.163 70.8423C491.618 70.8423 497.719 67.2735 501.38 64.24V46.4853H486.301L483.598 52.1953H494.756V61.2065L494.581 61.385C491.618 63.5263 487.521 64.7753 483.424 64.7753C474.097 64.7753 467.647 58.0838 467.647 48.5373V48.4481C467.647 39.6154 474.446 32.3886 482.727 32.3886C488.48 32.3886 491.879 34.173 495.279 36.9388L499.637 31.8533C494.669 27.8384 489.874 26.2324 483.075 26.2324Z" fill="#009BBB"/>
<path d="M510.259 70.1968H541.252L539.602 64.3194H517.03V51.4958H536.216V45.6183H517.03V33.1509H539.255L540.904 27.2734H510.172V70.1968H510.259Z" fill="#009BBB"/>
<path d="M243.231 14.1521C241.964 14.1521 240.862 13.8798 239.925 13.3351C238.987 12.7778 238.265 11.9861 237.759 10.9601C237.265 9.92146 237.018 8.69913 237.018 7.29313C237.018 5.88713 237.265 4.67113 237.759 3.64513C238.265 2.61912 238.987 1.83379 239.925 1.28913C240.862 0.731792 241.964 0.453125 243.231 0.453125C244.155 0.453125 245.004 0.598791 245.777 0.890125C246.549 1.16879 247.221 1.58679 247.791 2.14413L247.202 3.34112C246.556 2.79646 245.922 2.40379 245.302 2.16313C244.681 1.92246 243.997 1.80213 243.25 1.80213C241.78 1.80213 240.64 2.28346 239.83 3.24613C239.032 4.19613 238.633 5.54513 238.633 7.29313C238.633 9.05379 239.032 10.4155 239.83 11.3781C240.64 12.3281 241.78 12.8031 243.25 12.8031C243.997 12.8031 244.681 12.6828 245.302 12.4421C245.922 12.2015 246.556 11.8088 247.202 11.2641L247.791 12.4611C247.221 13.0185 246.549 13.4428 245.777 13.7341C245.004 14.0128 244.155 14.1521 243.231 14.1521Z" fill="#999999"/>
<path d="M257.095 14.1521C255.347 14.1521 254.023 13.6961 253.124 12.7841C252.225 11.8721 251.775 10.5295 251.775 8.75613V0.605125H253.314V8.88913C253.314 10.1938 253.631 11.1755 254.264 11.8341C254.91 12.4928 255.854 12.8221 257.095 12.8221C258.336 12.8221 259.274 12.4928 259.907 11.8341C260.54 11.1755 260.857 10.1938 260.857 8.88913V0.605125H262.415V8.75613C262.415 10.5168 261.959 11.8595 261.047 12.7841C260.148 13.6961 258.83 14.1521 257.095 14.1521Z" fill="#999999"/>
<path d="M271.375 14.1521C269.285 14.1521 267.613 13.5885 266.359 12.4611L266.967 11.2641C267.626 11.8215 268.297 12.2205 268.981 12.4611C269.678 12.7018 270.482 12.8221 271.394 12.8221C272.471 12.8221 273.3 12.6131 273.883 12.1951C274.466 11.7771 274.757 11.1881 274.757 10.4281C274.757 9.98479 274.618 9.62379 274.339 9.34513C274.06 9.06646 273.693 8.84479 273.237 8.68013C272.781 8.51546 272.167 8.34446 271.394 8.16713C270.355 7.92646 269.5 7.67313 268.829 7.40713C268.17 7.14113 267.632 6.76113 267.214 6.26713C266.809 5.77313 266.606 5.12713 266.606 4.32913C266.606 3.56913 266.802 2.89779 267.195 2.31513C267.6 1.71979 268.17 1.26379 268.905 0.947125C269.652 0.617792 270.514 0.453125 271.489 0.453125C272.414 0.453125 273.275 0.598791 274.073 0.890125C274.884 1.18146 275.568 1.59946 276.125 2.14413L275.536 3.34112C274.903 2.79646 274.257 2.40379 273.598 2.16313C272.952 1.90979 272.249 1.78313 271.489 1.78313C270.45 1.78313 269.633 2.00479 269.038 2.44812C268.455 2.87879 268.164 3.48679 268.164 4.27213C268.164 4.94346 268.424 5.45013 268.943 5.79213C269.462 6.13413 270.248 6.42546 271.299 6.66613C272.452 6.94479 273.357 7.20446 274.016 7.44513C274.675 7.67313 275.219 8.02146 275.65 8.49013C276.093 8.95879 276.315 9.58579 276.315 10.3711C276.315 11.1311 276.112 11.7961 275.707 12.3661C275.314 12.9361 274.744 13.3795 273.997 13.6961C273.25 14.0001 272.376 14.1521 271.375 14.1521Z" fill="#999999"/>
<path d="M283.297 1.93512H278.642V0.605125H289.548V1.93512H284.874V14.0001H283.297V1.93512Z" fill="#999999"/>
<path d="M297.693 14.1521C296.451 14.1521 295.368 13.8735 294.444 13.3161C293.532 12.7588 292.829 11.9671 292.335 10.9411C291.841 9.91513 291.594 8.70546 291.594 7.31213C291.594 5.90613 291.834 4.69013 292.316 3.66413C292.81 2.62546 293.513 1.83379 294.425 1.28913C295.349 0.731792 296.439 0.453125 297.693 0.453125C298.947 0.453125 300.03 0.731792 300.942 1.28913C301.866 1.83379 302.569 2.62546 303.051 3.66413C303.545 4.69013 303.792 5.89979 303.792 7.29313C303.792 8.68646 303.545 9.90246 303.051 10.9411C302.557 11.9671 301.847 12.7588 300.923 13.3161C300.011 13.8735 298.934 14.1521 297.693 14.1521ZM297.693 12.8221C299.111 12.8221 300.213 12.3471 300.999 11.3971C301.797 10.4345 302.196 9.06646 302.196 7.29313C302.196 5.51979 301.803 4.15812 301.018 3.20813C300.232 2.25813 299.124 1.78313 297.693 1.78313C296.274 1.78313 295.166 2.26446 294.368 3.22713C293.582 4.17713 293.19 5.53246 293.19 7.29313C293.19 9.05379 293.582 10.4155 294.368 11.3781C295.166 12.3408 296.274 12.8221 297.693 12.8221Z" fill="#999999"/>
<path d="M320.752 0.605125V14.0001H319.327L319.346 3.62613L314.995 11.8721H313.893L309.523 3.70212L309.542 14.0001H308.098V0.605125H309.39L314.463 10.3141L319.479 0.605125H320.752Z" fill="#999999"/>
<path d="M350.592 0.605125L345.918 14.0001H344.588L340.769 3.03713L336.95 14.0001H335.639L330.946 0.605125H332.523L336.323 11.7961L340.218 0.605125L341.396 0.624125L345.234 11.8151L349.072 0.605125H350.592Z" fill="#999999"/>
<path d="M354.383 0.605125H362.857V1.89713H355.922V6.55213H362.477V7.84413H355.922V12.7081H362.857V14.0001H354.383V0.605125Z" fill="#999999"/>
<path d="M374.541 7.12213C375.314 7.32479 375.909 7.70479 376.327 8.26213C376.758 8.81946 376.973 9.51613 376.973 10.3521C376.973 11.5301 376.587 12.4358 375.814 13.0691C375.042 13.6898 373.946 14.0001 372.527 14.0001H366.941V0.605125H372.318C373.699 0.605125 374.769 0.909125 375.529 1.51713C376.289 2.12513 376.669 2.98646 376.669 4.10113C376.669 4.82313 376.479 5.44379 376.099 5.96313C375.732 6.48246 375.213 6.86879 374.541 7.12213ZM368.48 6.55213H372.09C373.091 6.55213 373.845 6.34946 374.351 5.94413C374.871 5.53879 375.13 4.94979 375.13 4.17713C375.13 2.65713 374.117 1.89713 372.09 1.89713H368.48V6.55213ZM372.375 12.7081C373.427 12.7081 374.199 12.5181 374.693 12.1381C375.2 11.7455 375.453 11.1375 375.453 10.3141C375.453 8.66746 374.427 7.84413 372.375 7.84413H368.48V12.7081H372.375Z" fill="#999999"/>
<path d="M385.5 14.1521C383.41 14.1521 381.738 13.5885 380.484 12.4611L381.092 11.2641C381.751 11.8215 382.422 12.2205 383.106 12.4611C383.803 12.7018 384.607 12.8221 385.519 12.8221C386.596 12.8221 387.425 12.6131 388.008 12.1951C388.591 11.7771 388.882 11.1881 388.882 10.4281C388.882 9.98479 388.743 9.62379 388.464 9.34513C388.185 9.06646 387.818 8.84479 387.362 8.68013C386.906 8.51546 386.292 8.34446 385.519 8.16713C384.48 7.92646 383.625 7.67313 382.954 7.40713C382.295 7.14113 381.757 6.76113 381.339 6.26713C380.934 5.77313 380.731 5.12713 380.731 4.32913C380.731 3.56913 380.927 2.89779 381.32 2.31513C381.725 1.71979 382.295 1.26379 383.03 0.947125C383.777 0.617792 384.639 0.453125 385.614 0.453125C386.539 0.453125 387.4 0.598791 388.198 0.890125C389.009 1.18146 389.693 1.59946 390.25 2.14413L389.661 3.34112C389.028 2.79646 388.382 2.40379 387.723 2.16313C387.077 1.90979 386.374 1.78313 385.614 1.78313C384.575 1.78313 383.758 2.00479 383.163 2.44812C382.58 2.87879 382.289 3.48679 382.289 4.27213C382.289 4.94346 382.549 5.45013 383.068 5.79213C383.587 6.13413 384.373 6.42546 385.424 6.66613C386.577 6.94479 387.482 7.20446 388.141 7.44513C388.8 7.67313 389.344 8.02146 389.775 8.49013C390.218 8.95879 390.44 9.58579 390.44 10.3711C390.44 11.1311 390.237 11.7961 389.832 12.3661C389.439 12.9361 388.869 13.3795 388.122 13.6961C387.375 14.0001 386.501 14.1521 385.5 14.1521Z" fill="#999999"/>
<path d="M394.471 0.605125H396.029V14.0001H394.471V0.605125Z" fill="#999999"/>
<path d="M404.062 1.93512H399.407V0.605125H410.313V1.93512H405.639V14.0001H404.062V1.93512Z" fill="#999999"/>
<path d="M413.687 0.605125H422.161V1.89713H415.226V6.55213H421.781V7.84413H415.226V12.7081H422.161V14.0001H413.687V0.605125Z" fill="#999999"/>
<path d="M432.644 0.605125H437.147C439.288 0.605125 440.941 1.18779 442.106 2.35313C443.284 3.50579 443.873 5.15246 443.873 7.29313C443.873 9.43379 443.284 11.0868 442.106 12.2521C440.941 13.4175 439.288 14.0001 437.147 14.0001H432.644V0.605125ZM437.052 12.6701C440.523 12.6701 442.258 10.8778 442.258 7.29313C442.258 3.72112 440.523 1.93512 437.052 1.93512H434.202V12.6701H437.052Z" fill="#999999"/>
<path d="M448.19 0.605125H456.664V1.89713H449.729V6.55213H456.284V7.84413H449.729V12.7081H456.664V14.0001H448.19V0.605125Z" fill="#999999"/>
<path d="M464.819 14.1521C462.729 14.1521 461.057 13.5885 459.803 12.4611L460.411 11.2641C461.07 11.8215 461.741 12.2205 462.425 12.4611C463.122 12.7018 463.926 12.8221 464.838 12.8221C465.915 12.8221 466.745 12.6131 467.327 12.1951C467.91 11.7771 468.201 11.1881 468.201 10.4281C468.201 9.98479 468.062 9.62379 467.783 9.34513C467.505 9.06646 467.137 8.84479 466.681 8.68013C466.225 8.51546 465.611 8.34446 464.838 8.16713C463.8 7.92646 462.945 7.67313 462.273 7.40713C461.615 7.14113 461.076 6.76113 460.658 6.26713C460.253 5.77313 460.05 5.12713 460.05 4.32913C460.05 3.56913 460.247 2.89779 460.639 2.31513C461.045 1.71979 461.615 1.26379 462.349 0.947125C463.097 0.617792 463.958 0.453125 464.933 0.453125C465.858 0.453125 466.719 0.598791 467.517 0.890125C468.328 1.18146 469.012 1.59946 469.569 2.14413L468.98 3.34112C468.347 2.79646 467.701 2.40379 467.042 2.16313C466.396 1.90979 465.693 1.78313 464.933 1.78313C463.895 1.78313 463.078 2.00479 462.482 2.44812C461.9 2.87879 461.608 3.48679 461.608 4.27213C461.608 4.94346 461.868 5.45013 462.387 5.79213C462.907 6.13413 463.692 6.42546 464.743 6.66613C465.896 6.94479 466.802 7.20446 467.46 7.44513C468.119 7.67313 468.664 8.02146 469.094 8.49013C469.538 8.95879 469.759 9.58579 469.759 10.3711C469.759 11.1311 469.557 11.7961 469.151 12.3661C468.759 12.9361 468.189 13.3795 467.441 13.6961C466.694 14.0001 465.82 14.1521 464.819 14.1521Z" fill="#999999"/>
<path d="M473.79 0.605125H475.348V14.0001H473.79V0.605125Z" fill="#999999"/>
<path d="M490.753 7.02713V13.2211C490.221 13.4998 489.525 13.7278 488.663 13.9051C487.815 14.0698 486.953 14.1521 486.079 14.1521C484.749 14.1521 483.603 13.8798 482.64 13.3351C481.678 12.7905 480.937 12.0051 480.417 10.9791C479.911 9.95313 479.657 8.72446 479.657 7.29313C479.657 5.87446 479.911 4.65212 480.417 3.62613C480.924 2.60012 481.652 1.81479 482.602 1.27013C483.552 0.725458 484.673 0.453125 485.965 0.453125C486.903 0.453125 487.764 0.598791 488.549 0.890125C489.335 1.16879 490.006 1.58679 490.563 2.14413L489.974 3.34112C489.328 2.78379 488.689 2.38479 488.055 2.14413C487.435 1.90346 486.738 1.78313 485.965 1.78313C484.458 1.78313 483.299 2.25813 482.488 3.20813C481.678 4.15812 481.272 5.51979 481.272 7.29313C481.272 9.10446 481.684 10.4851 482.507 11.4351C483.331 12.3725 484.534 12.8411 486.117 12.8411C487.27 12.8411 488.34 12.6701 489.328 12.3281V8.24313H486.003V7.02713H490.753Z" fill="#999999"/>
<path d="M506.135 0.605125V14.0001H504.938L496.863 3.22713V14.0001H495.4V0.605125H496.597L504.672 11.3781V0.605125H506.135Z" fill="#999999"/>
<path d="M524.945 7.12213C525.717 7.32479 526.313 7.70479 526.731 8.26213C527.161 8.81946 527.377 9.51613 527.377 10.3521C527.377 11.5301 526.99 12.4358 526.218 13.0691C525.445 13.6898 524.349 14.0001 522.931 14.0001H517.345V0.605125H522.722C524.102 0.605125 525.173 0.909125 525.933 1.51713C526.693 2.12513 527.073 2.98646 527.073 4.10113C527.073 4.82313 526.883 5.44379 526.503 5.96313C526.135 6.48246 525.616 6.86879 524.945 7.12213ZM518.884 6.55213H522.494C523.494 6.55213 524.248 6.34946 524.755 5.94413C525.274 5.53879 525.534 4.94979 525.534 4.17713C525.534 2.65713 524.52 1.89713 522.494 1.89713H518.884V6.55213ZM522.779 12.7081C523.83 12.7081 524.603 12.5181 525.097 12.1381C525.603 11.7455 525.857 11.1375 525.857 10.3141C525.857 8.66746 524.831 7.84413 522.779 7.84413H518.884V12.7081H522.779Z" fill="#999999"/>
<path d="M536.214 7.67313V14.0001H534.656V7.65413L529.393 0.605125H531.198L535.454 6.38113L539.71 0.605125H541.477L536.214 7.67313Z" fill="#999999"/>
</svg>

        </a>
        <div class="amn-contact-details">
            <span class="sales-btn">
                Sales
                <a href="tel:' . $sales . '"><i class="ai-font-phone"></i> ' . $sales . '</a>
            </span>
            <span class="support-btn">
                Support
                <a href="//www.agentimage.com/support/" class="ai-num-dark"><i class="ai-font-phone"></i> ' . $support . '</a>
            </span>
        </div>
      </div>';

    // Get a SimplePie feed object from the specified feed source.
    $rss = fetch_feed($jsondata_ai_detail['feed_uri']);

    $max_items = 0;
    $rss_items = [];
    // Checks that the object is created correctly
    if (! is_wp_error($rss)) {
      // Figure out how many total items there are.
      $max_items = $rss->get_item_quantity($maximum_number_of_items_to_show);

      // Build an array of all the items, starting with element 0( i.e. first element ).
      $rss_items = $rss->get_items(0, $max_items);
    }

    if ($max_items == 0) {
      $feed_content = '<div class="no-items-to-show">Refresh to load news.</div>';
    } else {
      $feed_content .= '<div class="rss-widget"><ul>';
      foreach ($rss_items as $rss_item) {
        $enclosure = $rss_item->get_enclosure();
        $rss_item_title = $rss_item->get_title();
        $rss_item_page_url = $rss_item->get_permalink();
        $rss_item_date = $rss_item->get_date('M j, Y');

        $rss_item_content = $rss_item->get_content();

        // featuredimage - inserted using add_filter rss
        $regex = sprintf('/\<img class="rss-ai-feed" src="%s(.*?)"\>/', $jsondata_ai_detail['feed_image_regex']);
        preg_match($regex, $rss_item_content, $featured_image);

        /** Fallback */
        if (empty($featured_image)) {
          $regex = '/\<img class="rss-ai-feed" src="(.*?)"\>/';
          preg_match($regex, $rss_item_content, $featured_image);
        }

        // Cut off the rss_item_content and strip html tags
        $rss_item_excerpt = strip_tags($rss_item_content);
        if (($char_count = strlen($rss_item_excerpt)) > 250) {
          // Cut characters
          $rss_item_excerpt = substr( $rss_item_excerpt, 0, 250 );
          // Remove up until the last occurence of a space
          $rss_item_excerpt = substr( $rss_item_excerpt, 0, strrpos( $rss_item_excerpt, ' ' ) );
          // Add ellipsis
          $rss_item_excerpt .= '...';
        }

        // <canvas width="300" height="100" style="background-image: url( https://www.agentimage.com/' . $featured_image[1] . ' );"></canvas>
        $feed_content .= '<li>
          <div class="rssTitle">
            <a class="rsswidget" href="' . $rss_item_page_url . '" target="_blank">' . $rss_item_title . '</a>
            <span class="rss-date">' . $rss_item_date . '</span>
          </div>
          <div class="rssContainer">
            <div class="rssSummaryImg">
              <a class="rsswidget" href="' . $rss_item_page_url . '" target="_blank">
                <canvas width="300" height="100" style="background-image: url(' . $featured_image[1] . ');"></canvas>
              </a>
            </div>
            <div class="rssSummary">' . $rss_item_excerpt . '</div>
          </div>
        </li>';
      }
      $feed_content .= '</ul></div>';
    }
    $feed_content .= '<a href="//www.agentimage.com/blog/" target="_blank" class="amn-more-tips">More Real Estate Marketing Tips</a>';
    echo $feed_content;
  }
}

new DashboardController();
